name: Build Native Installers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 2.11.2)'
        required: false
        default: ''

env:
  APP_NAME: "PX Submission Tool"
  APP_VENDOR: "PRIDE Team - EMBL-EBI"
  APP_DESCRIPTION: "ProteomeXchange Submission Tool for submitting proteomics data to PRIDE Archive"

jobs:
  # Build the fat JAR first (shared artifact)
  build-jar:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Build fat JAR
        run: mvn clean package -DskipTests

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/px-submission-tool-*.jar
          retention-days: 1

      - name: Upload resources
        uses: actions/upload-artifact@v4
        with:
          name: app-resources
          path: |
            src/main/resources/icons/
            aspera/
            help/
            config/
          retention-days: 1

  # Windows installer (.exe/.msi)
  build-windows:
    needs: build-jar
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/

      - name: Download resources
        uses: actions/download-artifact@v4
        with:
          name: app-resources
          path: resources/

      - name: Find JAR file
        id: find-jar
        shell: pwsh
        run: |
          $jar = Get-ChildItem -Path target -Filter "px-submission-tool-*.jar" | Select-Object -First 1
          echo "JAR_FILE=$($jar.FullName)" >> $env:GITHUB_OUTPUT
          echo "Found JAR: $($jar.FullName)"

      - name: Create Windows installer
        shell: pwsh
        run: |
          $version = "${{ needs.build-jar.outputs.version }}"
          # Remove -SNAPSHOT suffix for installer version (must be numeric)
          $cleanVersion = $version -replace "-SNAPSHOT", "" -replace "[^0-9.]", ""
          if ($cleanVersion -eq "") { $cleanVersion = "1.0.0" }

          # Ensure version has at least 3 parts
          $parts = $cleanVersion.Split(".")
          while ($parts.Count -lt 3) { $parts += "0" }
          $cleanVersion = $parts[0..2] -join "."

          echo "Building version: $cleanVersion"

          # Create input directory
          New-Item -ItemType Directory -Force -Path jpackage-input
          Copy-Item "${{ steps.find-jar.outputs.JAR_FILE }}" -Destination jpackage-input/

          # Create resource directory for icon
          New-Item -ItemType Directory -Force -Path jpackage-resources
          if (Test-Path "resources/icons/px-logo.ico") {
            Copy-Item "resources/icons/px-logo.ico" -Destination jpackage-resources/
          }

          # Build MSI installer
          jpackage `
            --type msi `
            --name "PX-Submission-Tool" `
            --app-version $cleanVersion `
            --vendor "${{ env.APP_VENDOR }}" `
            --description "${{ env.APP_DESCRIPTION }}" `
            --input jpackage-input `
            --main-jar (Get-ChildItem jpackage-input -Filter "*.jar" | Select-Object -First 1).Name `
            --main-class uk.ac.ebi.pride.pxsubmit.Launcher `
            --java-options "--enable-native-access=ALL-UNNAMED" `
            --win-dir-chooser `
            --win-menu `
            --win-shortcut `
            --win-shortcut-prompt `
            --dest output

          # Also build EXE installer
          jpackage `
            --type exe `
            --name "PX-Submission-Tool" `
            --app-version $cleanVersion `
            --vendor "${{ env.APP_VENDOR }}" `
            --description "${{ env.APP_DESCRIPTION }}" `
            --input jpackage-input `
            --main-jar (Get-ChildItem jpackage-input -Filter "*.jar" | Select-Object -First 1).Name `
            --main-class uk.ac.ebi.pride.pxsubmit.Launcher `
            --java-options "--enable-native-access=ALL-UNNAMED" `
            --win-dir-chooser `
            --win-menu `
            --win-shortcut `
            --win-shortcut-prompt `
            --dest output

      - name: List output
        shell: pwsh
        run: Get-ChildItem -Path output -Recurse

      - name: Upload Windows installers
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: output/*
          retention-days: 30

  # macOS installer (.dmg/.pkg)
  build-macos:
    needs: build-jar
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/

      - name: Download resources
        uses: actions/download-artifact@v4
        with:
          name: app-resources
          path: resources/

      - name: Find JAR file
        id: find-jar
        run: |
          JAR_FILE=$(find target -name "px-submission-tool-*.jar" | head -1)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_FILE"

      - name: Create macOS installer
        run: |
          VERSION="${{ needs.build-jar.outputs.version }}"
          # Remove -SNAPSHOT suffix for installer version
          CLEAN_VERSION=$(echo "$VERSION" | sed 's/-SNAPSHOT//' | sed 's/[^0-9.]//g')
          if [ -z "$CLEAN_VERSION" ]; then CLEAN_VERSION="1.0.0"; fi

          # Ensure version has at least 3 parts
          IFS='.' read -ra PARTS <<< "$CLEAN_VERSION"
          while [ ${#PARTS[@]} -lt 3 ]; do PARTS+=("0"); done
          CLEAN_VERSION="${PARTS[0]}.${PARTS[1]}.${PARTS[2]}"

          echo "Building version: $CLEAN_VERSION"

          # Create input directory
          mkdir -p jpackage-input
          cp "${{ steps.find-jar.outputs.JAR_FILE }}" jpackage-input/

          # Get JAR name
          JAR_NAME=$(basename "${{ steps.find-jar.outputs.JAR_FILE }}")

          mkdir -p output

          # Build DMG
          jpackage \
            --type dmg \
            --name "PX-Submission-Tool" \
            --app-version "$CLEAN_VERSION" \
            --vendor "${{ env.APP_VENDOR }}" \
            --description "${{ env.APP_DESCRIPTION }}" \
            --input jpackage-input \
            --main-jar "$JAR_NAME" \
            --main-class uk.ac.ebi.pride.pxsubmit.Launcher \
            --java-options "--enable-native-access=ALL-UNNAMED" \
            --mac-package-name "PX Submission Tool" \
            --dest output

          # Build PKG
          jpackage \
            --type pkg \
            --name "PX-Submission-Tool" \
            --app-version "$CLEAN_VERSION" \
            --vendor "${{ env.APP_VENDOR }}" \
            --description "${{ env.APP_DESCRIPTION }}" \
            --input jpackage-input \
            --main-jar "$JAR_NAME" \
            --main-class uk.ac.ebi.pride.pxsubmit.Launcher \
            --java-options "--enable-native-access=ALL-UNNAMED" \
            --mac-package-name "PX Submission Tool" \
            --dest output

      - name: List output
        run: ls -la output/

      - name: Upload macOS installers
        uses: actions/upload-artifact@v4
        with:
          name: macos-installers
          path: output/*
          retention-days: 30

  # Linux installers (.deb/.rpm)
  build-linux:
    needs: build-jar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot rpm

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/

      - name: Download resources
        uses: actions/download-artifact@v4
        with:
          name: app-resources
          path: resources/

      - name: Find JAR file
        id: find-jar
        run: |
          JAR_FILE=$(find target -name "px-submission-tool-*.jar" | head -1)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_FILE"

      - name: Create Linux installers
        run: |
          VERSION="${{ needs.build-jar.outputs.version }}"
          # Remove -SNAPSHOT suffix for installer version
          CLEAN_VERSION=$(echo "$VERSION" | sed 's/-SNAPSHOT//' | sed 's/[^0-9.]//g')
          if [ -z "$CLEAN_VERSION" ]; then CLEAN_VERSION="1.0.0"; fi

          # Ensure version has at least 3 parts
          IFS='.' read -ra PARTS <<< "$CLEAN_VERSION"
          while [ ${#PARTS[@]} -lt 3 ]; do PARTS+=("0"); done
          CLEAN_VERSION="${PARTS[0]}.${PARTS[1]}.${PARTS[2]}"

          echo "Building version: $CLEAN_VERSION"

          # Create input directory
          mkdir -p jpackage-input
          cp "${{ steps.find-jar.outputs.JAR_FILE }}" jpackage-input/

          # Get JAR name
          JAR_NAME=$(basename "${{ steps.find-jar.outputs.JAR_FILE }}")

          mkdir -p output

          # Build DEB
          jpackage \
            --type deb \
            --name "px-submission-tool" \
            --app-version "$CLEAN_VERSION" \
            --vendor "${{ env.APP_VENDOR }}" \
            --description "${{ env.APP_DESCRIPTION }}" \
            --input jpackage-input \
            --main-jar "$JAR_NAME" \
            --main-class uk.ac.ebi.pride.pxsubmit.Launcher \
            --java-options "--enable-native-access=ALL-UNNAMED" \
            --linux-menu-group "Science" \
            --linux-shortcut \
            --dest output

          # Build RPM
          jpackage \
            --type rpm \
            --name "px-submission-tool" \
            --app-version "$CLEAN_VERSION" \
            --vendor "${{ env.APP_VENDOR }}" \
            --description "${{ env.APP_DESCRIPTION }}" \
            --input jpackage-input \
            --main-jar "$JAR_NAME" \
            --main-class uk.ac.ebi.pride.pxsubmit.Launcher \
            --java-options "--enable-native-access=ALL-UNNAMED" \
            --linux-menu-group "Science" \
            --linux-shortcut \
            --dest output

      - name: List output
        run: ls -la output/

      - name: Upload Linux installers
        uses: actions/upload-artifact@v4
        with:
          name: linux-installers
          path: output/*
          retention-days: 30

  # Create release with all installers
  create-release:
    needs: [build-jar, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all installers
        uses: actions/download-artifact@v4
        with:
          path: installers/

      - name: List all installers
        run: |
          echo "All downloaded artifacts:"
          find installers -type f -name "*" | head -50

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Move all installers to release-assets with descriptive names
          VERSION="${{ needs.build-jar.outputs.version }}"

          # Windows
          find installers/windows-installers -name "*.msi" -exec cp {} release-assets/PX-Submission-Tool-${VERSION}-windows.msi \; 2>/dev/null || true
          find installers/windows-installers -name "*.exe" -exec cp {} release-assets/PX-Submission-Tool-${VERSION}-windows.exe \; 2>/dev/null || true

          # macOS
          find installers/macos-installers -name "*.dmg" -exec cp {} release-assets/PX-Submission-Tool-${VERSION}-macos.dmg \; 2>/dev/null || true
          find installers/macos-installers -name "*.pkg" -exec cp {} release-assets/PX-Submission-Tool-${VERSION}-macos.pkg \; 2>/dev/null || true

          # Linux
          find installers/linux-installers -name "*.deb" -exec cp {} release-assets/px-submission-tool-${VERSION}-linux.deb \; 2>/dev/null || true
          find installers/linux-installers -name "*.rpm" -exec cp {} release-assets/px-submission-tool-${VERSION}-linux.rpm \; 2>/dev/null || true

          echo "Release assets:"
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          draft: false
          prerelease: false
          body: |
            ## PX Submission Tool ${{ github.ref_name }}

            ### Native Installers (Recommended)
            Download the installer for your operating system - no Java installation required!

            | Platform | Installer | Notes |
            |----------|-----------|-------|
            | **Windows** | `.exe` or `.msi` | Double-click to install |
            | **macOS** | `.dmg` or `.pkg` | Drag to Applications or run installer |
            | **Linux (Debian/Ubuntu)** | `.deb` | `sudo dpkg -i px-submission-tool-*.deb` |
            | **Linux (Fedora/RHEL)** | `.rpm` | `sudo rpm -i px-submission-tool-*.rpm` |

            ### Features
            - Bundled Java runtime - no need to install Java separately
            - Native look and feel for each platform
            - Desktop shortcuts and start menu entries
            - Automatic updates support

            ### Documentation
            - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [PRIDE Archive](https://www.ebi.ac.uk/pride/)
            - [ProteomeXchange](https://www.proteomexchange.org/)

            ---
            *Built with the PRIDE Team*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
